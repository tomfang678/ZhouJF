$(function () {
    function cookiedata(n) {
        for (var r = document.cookie.split("; "), t = 0, i, t = 0; t < r.length; t++)
            if (i = r[t].split("="), i[0] == n) return i[1]; return ""
    }
    function drawCricle(n, t, i) { /*覆盖区域名*/ this._text = n; this._Lat = t; this._Lng = i }
    /*1、根据房源绘制区域地图层 n 为map实例*/
    function getRegion() {
        $.ajax({
            type: "GET", url: "/ZuFang/GetRegions", data: { cityid: l }, dataType: "json",
            success: function (t) {
                for (var f, i = 0; i < t.length; i++)
                    f = new drawCricle(t[i].Name, t[i].Lat, t[i].Lng), n.addOverlay(f), $(f.domElement).click(function () {
                        var t = $(this).attr("data-load-lng"), i = $(this).attr("data-load-lat");
                        n.centerAndZoom(new BMap.Point(t, i), 15);
                        e(r, u)
                    })
            }
        })
    }
    /*搜索功能*/
    function w(n) { this.o = { id: "", Lng: "", Lat: "", Address: "", Id: "", MinRental: "", Name: "", RoomCount: "" }; for (var t in n) this.o[t] = n[t] }
    function e(i, r) {
        $(".inputName").blur(); var e = $(".sel_map").width(), s = $(".loadMap").width(),
            f = (e - s) / 2, u = d(), h = u.bssw.lng, l = u.bsne.lng, y = u.bssw.lat, p = u.bsne.lat; $(".loadMap").css({ left: f + "px" }); $(".loadpop").css({ display: "block" }); $(".notHoust").css({ display: "none" }); b(); c.mapserach(h, l, y, p, i, r, function (u) { var e, s; if (u.HasResult) { for ($(".notHoust").css({ display: "none" }), $(".house_list").attr("data-count", u.RoomCount), u.RoomCount <= 15 && $(".page button").attr("disabled", "disabled"), e = 0; e < u.Communities.length; e++) { s = new w(u.Communities[e]); n.addOverlay(s); $(s._wrapDiv).hover(function () { var n = this; t = setTimeout(function () { $(n).find(".houseInfo").css({ "z-index": 1e3 }); $(n).find(".toggleDiv").fadeOut(0); $(n).find(".houseInfo").fadeIn(0); $(n).find(".houseInfo").attr("data-id") == o && $(n).find(".houseInfo").css({ display: "block", cursor: "pointer" }) }, 200) }, function () { var n = this; clearTimeout(t); $(this).find(".houseInfo").css({ "z-index": null }); $(n).find(".houseInfo").fadeOut(0); $(n).find(".toggleDiv").fadeIn(0); $(n).find(".houseInfo").attr("data-id") == o && $(n).find(".houseInfo").css({ display: "block" }) }); $(s.houseInfo).on("click", function () { var t, n, u; isClick = !1; $(".house_list").scrollTop(0); t = o = $(this).attr("data-id"); n = $(this).attr("data-remainihouse"); $(".house_list").attr("data-count", n); console.log("count" + n); n <= 15 ? ($(".page button").attr("disabled", "disabled"), $(".page button").css({ background: "#a0a0a0", color: "#f0f0f0" })) : ($(".page button").removeAttr("disabled"), $(".page button").removeAttr("style")); u = 1; i = $(".price").attr("data-pos-cfg") || 1; r = $(".cfg").attr("data-pos-cfg") || 1; $(".houseInfo").css({ display: "none" }); $(".house_list").find("div").removeClass("house-pos-display"); $(this).find("div").attr("class", "house-pos-display"); c.SearchRooms(t, u, i, r, function (n) { console.log(n); n.RoomCount > 0 ? a(n.Rooms) : v() }) }) } $(".loadpop").css({ display: "none" }) } else n.clearOverlays(), $(".loadMap").css({ left: f + "px" }), setTimeout(function () { $(".loadpop").css({ display: "none" }) }, 800), setTimeout(function () { $(".notHoust").css({ display: "block" }) }, 800); a(u.Rooms) })
    }
    /*搜索功能*/
    function it() {
        var t = l;
        c.GetSearchTips(t, function (t) {
            $(".inputName").typeahead({
                source: function (n, i) {
                    var r = _.map(t, function (n) {
                        return n.Name
                    }); i(r)
                }, highlighter: function (n) {
                    //console.log("item");
                    for (var r = 0; r < t.length; r++) t[r].Name.indexOf(n) !== -1 && i.push(t[r]);
                    return console.log(i), $(".inputName").attr("data-lat", i[0].Lat), $(".inputName").attr("data-lng", i[0].Lng), n
                },
                updater: function (t) {
                    console.log("updater");
                    for (var f = 0; f < i.length; f++) i[f].Name.indexOf(t) !== -1 && ($(this.$element).attr("data-Lng", i[f].Lng), $(this.$element).attr("data-Lat", i[f].Lat), i[f].Lat > 0 && i[f].Lng > 0 ? (n.centerAndZoom(new BMap.Point(i[f].Lng, i[f].Lat), 15), e(r, u)) : (n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays())); return t
                }
            })
        })
    }
    /*清除地图层*/
    function b() { n.clearOverlays() }
    function k() { $(".sel_map").css({ dipslay: "block", "margin-left": "370px" }); $(".serach_map_house").fadeIn(200); $(".serach_house_name").fadeIn(200) }
    function d() { var t = n.getBounds(), i = t.getSouthWest(), r = t.getNorthEast(); return { bs: t, bssw: i, bsne: r } }
    /*房间信息列表*/
    function a(n) {
        var t = [], i, r; if (n !== undefined) {
            for (i = 0; i < n.length; i++) t.push('<div class="serach_house_item">'),
                t.push("<a href=/ZuFang/Detail?ID=" + n[i].SourceId + ' target="_blank" class="mulch"><\/a>'), t.push("<a href=" + n[i].Url + ' target="_blank">'),
                t.push('<div class="house_preview" style="background:url(' + n[i].Url + ') no-repeat;background-size:100% 100%;">'), t.push("<\/div>"), t.push('<div class="house_info">'), t.push("<label>"), t.push(n[i].BaseTitle), t.push("<\/label>"), t.push("<label>"), t.push(n[i].ExtendURL), t.push("<\/label>"), t.push("<label>"), n[i].IsToilet == 1 && t.push("<em>独卫<\/em> "), n[i].IsWindow == 1 && t.push("<em>飘窗<\/em> "), n[i].IsBalcony == 1 && t.push("<em>阳台<\/em> "), t.push("<\/label>"), t.push("<label>"), t.push("<span>" + n[i].Acreage + "㎡<\/span> <span>￥" + n[i].Rental + "<\/span>"), t.push("<\/label>"), t.push("<\/div>"), t.push("<\/a>"), t.push("<\/div>");
            $(".house_list").html(t.join(""));
            r = $(".serach_house_item").first().css({ "margin-top": "0px" });
            r = $(".serach_house_item").last().css({ "margin-bottom": "30px" })
        } else v()
    }
    function v() {
        var n = [];
        //n.push('<img src="../../Content/map/null.png">');
        $(".inputName").val() === "" ? n.push('<p class="housing">没有检索到房源<\/p>') : n.push('<p class="housing">请选择右侧房源<' + $(".inputName").val() + "><\/p>");
        $(".page button").css({ display: "none" });
        $(".house_list").html(n.join(""));
        $(".house_list img").css({ margin: "0 auto", "margin-top": "180px", display: "block" })
    }
    var c = {
        _get: function (n, t, i, r) { this._ajax("get", n, t, i, r) }, _post: function (n, t, i, r) { this._ajax("post", n, t, i, r) },
        _ajax: function (n, t, i, r) {
            var u = {
                url: t, type: n || get, data: i, dataType: "json", success: r,
                error: function () { }
            };
            $.ajax(u)
        },
        loadMap: function (n, t, i, r) { this._get(n, { cityid: t }, i, r) },
        mapserach: function (n, t, i, r, u, f, e, o) { this._post("/ZuFang/SearchCommunities", { fromlng: n, tolng: t, fromlat: i, tolat: r, price: u, cfg: f }, e, o) },
        GetSearchTips: function (n, t) { this._post("/ZuFang/GetSearchTips", { cityid: n }, t) },
        SearchRooms: function (n, t, i, r, u) { this._post("/ZuFang/SearchRooms", { communityIds: n, page: t, price: i, cfg: r }, u) }
    }, r = 1, u = 1, l = cookiedata("CitySwitch"), s, h, n, o, tt, y, i, f;
    //l || $.cookie("CitySwitch", "10000"); l == "10000" ? (s = 104.059087, h = 30.662292) : l == "10001" ? (s = 106.33, h = 30.594763) : l == "10020" ? (s = 116.380122, h = 29.35) : l == "10039" && (s = 120.161693, h = 30.280059);
    s = 106.54910;
    h = 29.54906;
    //创建地图实例
    n = new BMap.Map("allmap", { minZoom: 10, maxZoom: 20 });
    //创建点坐标 初始化地图 设置中心点坐标和地图级别
    n.centerAndZoom(new BMap.Point(s, h), 13); n.enableDragging();
    n.enableScrollWheelZoom(!0);
    drawCricle.prototype = new BMap.Overlay;
    drawCricle.prototype.initialize = function (n) {
        var t, i; return this._map = n, t = this._div = document.createElement("div"),
            t.style.position = "absolute", t.style.background = "url('../../content/map/area.png') no-repeat",
            t.style.height = "160px", t.style.width = "160px", t.style.textAlign = "center", t.style.lineHeight = "160px", t.style.color = "#fff",
            t.style.fontSize = "16px", t.style.fontWeight = "600", t.style.whiteSpace = "nowrap",
            t.style.MozUserSelect = "none", t.style.cursor = "pointer", t.style.zIndex = "1000000",
            $(t).attr("class", "loadMap"), $(t).attr("data-load-lng", this._Lng),
            $(t).attr("data-load-lat", this._Lat), i = document.createElement("span"),
            i.appendChild(document.createTextNode(this._text)), t.appendChild(i), n.getPanes().labelPane.appendChild(t), t
    }; drawCricle.prototype.draw = function () {
        var t = new BMap.Point(this._Lng, this._Lat), n = this._map.pointToOverlayPixel(t); this._div.style.left = n.x - 95 + "px"; this._div.style.top = n.y - 75 + "px"
    };
    getRegion();
    w.prototype = new BMap.Overlay;
    /*房源信息列表层*/
    w.prototype.initialize = function (n) {
        var o, t, v, r, i, l, u, f, h, a, s, c, e, y;
        return this._map = n, o = this._wrapDiv = document.createElement("div"), $(o).attr("class", "posHouseDiv"), o.style.position = "absolute",
            t = document.createElement("div"), t.style.padding = "7px 13px", t.style.border = "3px solid #FF5300", t.style.borderRadius = "30px",
            t.style.fontSize = "14px", t.style.position = "absolute", t.style.zIndex = "1", t.style.bottom = "-40px",
            t.style.left = "0px", t.style.background = "#fff", t.style.fontWeight = "bold", t.style.textAlign = "center",
            t.style.color = "#4b5264", t.style.boxShadow = "3px 4px 3px #CDCCCC", t.style.whiteSpace = "nowrap",
            $(t).attr("class", "toggleDiv"), v = document.createElement("span"), v.appendChild(document.createTextNode(this.o.Name)),
            r = document.createElement("i"), r.style.display = "inline-block", r.style.width = "12px", r.style.height = "8px",
            r.style.position = "absolute", r.style.background = "url('../../content/map/11_03.png') no-repeat",
            r.style.bottom = "-8px", r.style.left = "14px", t.appendChild(v), t.appendChild(r),
            i = this.houseInfo = document.createElement("div"), i.style.boxShadow = " 3px 4px 2px #cdcccc",
            i.style.position = "absolute", i.style.padding = "7px 20px", i.style.border = "3px solid #398dee", i.style.background = "#fff",
            i.style.borderRadius = "60px", i.style.bottom = "-39px", i.style.left = "-9px", i.style.display = "none",
            $(i).attr("class", "houseInfo"), $(i).attr("data-id", this.o.Id),
            $(i).attr("data-remainiHouse", this.o.RoomCount), l = document.createElement("div"), l.style.whiteSpace = "nowrap",
            u = document.createElement("label"), u.style.color = "#4b5264", u.style.fontSize = "14px", u.style.fontWeight = "bold",
            u.style.cursor = "pointer", u.appendChild(document.createTextNode(this.o.Name + "-")), f = document.createElement("label"),
            f.style.color = "#4b5264", f.style.marginLeft = "40px", f.style.fontWeight = "normal",
            f.style.cursor = "pointer", h = document.createElement("span"), h.style.fontWeight = "normal", h.appendChild(document.createTextNode("剩余")),
            a = document.createElement("em"), a.style.fontStyle = "normal", a.style.color = "#ff5300", a.appendChild(document.createTextNode(this.o.RoomCount)),
            s = document.createElement("span"), s.style.fontWeight = "bold", s.style.color = "#ff5300", s.style.fontSize = "12px", s.appendChild(document.createTextNode("￥")),
            c = document.createElement("em"), c.style.fontSize = "14px", c.style.fontStyle = "normal", c.style.color = "#ff5300",
            c.appendChild(document.createTextNode(this.o.MinRental)), e = document.createElement("p"), e.style.color = "#4b5264",
            e.style.fontSize = "14px", e.style.margin = "0", e.style.whiteSpace = "nowrap", e.appendChild(document.createTextNode(this.o.Address)),
            e.style.cursor = "pointer", i.appendChild(l), l.appendChild(u), u.appendChild(h), h.appendChild(a), o.appendChild(t),
            o.appendChild(i), $(h).find("em").after("个房间"), l.appendChild(f), f.appendChild(s), s.appendChild(c),
            y = $(f).find("span").after("起"), i.appendChild(e), $(i).find("p").after('<span class="sanjiao1"><\/span>'), n.getPanes().labelPane.appendChild(o), o
    };
    w.prototype.draw = function () {
        var t = new BMap.Point(this.o.Lng, this.o.Lat),
            n = this._map.pointToOverlayPixel(t);
        this._wrapDiv.style.left = n.x - 16 + "px"; this._wrapDiv.style.top = n.y - 57 + "px"
    };
    n.addEventListener("click",
        function () { var n = d(); $(".inputName").removeAttr("data-lng"); $(".inputName").removeAttr("data-lat") });
    n.addEventListener("zoomend", function () {
        o = ""; k(); $(".house_list").scrollTop(0);
        b();
        $(".inputName").attr("data-lng") === undefined || $(".inputName").attr("data-lat") === undefined ? $(".inputName").attr("data-lat") > 0 || $(".inputName").attr("data-lat") === undefined ? e(r, u) : ($(".inputName").removeAttr("data-lng"), $(".inputName").removeAttr("data-lat"), $(".notHoust").show(), v()) : $(".inputName").attr("data-lat") > 0 ? e(r, u) : ($(".inputName").removeAttr("data-lng"), $(".inputName").removeAttr("data-lat"), $(".notHoust").show(), v()); $(".page button").removeAttr("disabled"); $(".page button").removeAttr("style"); $(".page button").removeClass("click-btn btn-disable")
    });
    n.addEventListener("dragend", function () {
        $(".house_list").scrollTop(0); o = ""; $(".inputName").removeAttr("data-lng"); $(".inputName").removeAttr("data-lat");
        n.enableDragging();
        b();
        k(); n.enableInertialDragging(); e(r, u);
        $(".page button").removeAttr("disabled");
        $(".page button").removeAttr("style");
        $(".page button").removeClass("click-btn btn-disable")
    });
    n.addEventListener("dblclick", function () {
        $(".house_list").scrollTop(0); o = ""; b(); e(r, u);
        $(".page button").removeAttr("disabled");
        $(".page button").removeAttr("style");
        $(".page button").removeClass("click-btn btn-disable")
    });
    o = "";
    tt = [];
    y = { "data-Lng": "", "data-Lat": "" };
    i = [];
    /*搜索事件*/
    $(".inputName").keydown(function (t) {
        if (t.keyCode === 13) {
            var f = $(".inputName").attr("data-Lat"), o = $(".inputName").attr("data-Lng");
            $(this).val($(".active").text());
            f !== undefined && o !== undefined ? f > 0 && o > 0 ? (n.centerAndZoom(new BMap.Point(o, f), 15), e(r, u)) : $(this).val().length > 0 ? i[0].Name.indexOf($(this).val()) !== -1 && (n.centerAndZoom(new BMap.Point(i[0].Lng, i[0].Lat), 15), e(r, u)) : ($(".notHoust").show(), $(".inputName").removeAttr("data-Lng"), $(".inputName").removeAttr("data-Lat"), n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays()) : ($(".inputName").attr({ "data-Lat": y["data-Lat"], "data-Lng": y["data-Lng"] }), f > 0 && o > 0 ? (n.centerAndZoom(new BMap.Point(o, f), 15), e(r, u)) : $(this).val().length > 0 ? i[0].Name.indexOf($(this).val()) !== -1 && (n.centerAndZoom(new BMap.Point(i[0].Lng, i[0].Lat), 15), e(r, u)) : (
            $(".notHoust").show(), n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays(), $(".inputName").removeAttr("data-Lng"), $(".inputName").removeAttr("data-Lat")))
        }
        t.keyCode === 8 && (i = [], $(".inputName").removeAttr("data-Lat"), $(".inputName").removeAttr("data-Lng"))
    });
    it();
    $(document).bind("keyup", function (t) {
        if (t.keyCode == 13) {
            var i = $(".inputName").attr("data-Lat"), f = $(".inputName").attr("data-Lng"); i !== undefined && f !== undefined ? i > 0 && f > 0 ? (n.centerAndZoom(new BMap.Point(f, i), 15), e(r, u)) : console.log("doc=8") : ($(".inputName").attr({ "data-Lat": y["data-Lat"], "data-Lng": y["data-Lng"] }), i > 0 && f > 0 ? (n.centerAndZoom(new BMap.Point(f, i), 15), e(r, u)) : ($(".notHoust").show(), n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays(), $(".inputName").removeAttr("data-Lng"), $(".inputName").removeAttr("data-Lat")))
        }
    });
    $(".conditions div").hover(function () {
        $(this).find("span").addClass("selNav"); $(this).find("i").addClass("sanjiao"); $(this).find(".sel_more").show()
    }, function () {
        var n = $(this).closest("div").find("span"), t = n.attr("data-pos");
        t || ($(this).find("span").removeClass("selNav"), $(this).find("i").removeClass("sanjiao"));
        $(this).find(".sel_more").hide()
    });
    $(".sel_more li").on({
        click: function () {
            var t, n; t = $(this).text(); $(this).closest("div").find("span").attr("data-pos-cfg", $(this).attr("data-value")); $(".conditions span").removeClass("selNav"); $(".conditions span i").removeClass("sanjiao"); $(".conditions span").removeAttr("data-pos"); n = $(this).closest("div").find("span"); n.html(t + " <i><\/i>"); n.addClass("selNav"); n.find("i").addClass("sanjiao"); $(".sel_more").hide(); n.attr("data-pos", !0); r = $(".price").attr("data-pos-cfg") || 1; u = $(".cfg").attr("data-pos-cfg") || 1;
            f = 0;
            $(this).closest("div").find(".price").length > 0?c.SearchRooms( f, r, u,
                function (n) {
                    v()
                }) : e(r, u);
            //$(this).closest("div").find(".price").length > 0 ? o ? c.SearchRooms(o, f, r, u,
            //    function (n) { n.RoomCount > 0 ? a(n.Rooms) : v() }) : e(r, u) : o ? c.SearchRooms(o, f, r, u, function (n) { n.RoomCount > 0 ? a(n.Rooms) : v() }) : e(r, u)
        }
    }); f = 1;
    $(".page button").on("click", function () {
        var t, i; $(".house_list").scrollTop(0); t = []; $(".page button").removeAttr("class");
        $(this).addClass("click-btn"); var s = $(".houseInfo:hidden"), e = $(".house_list").attr("data-count"), n = Math.ceil(e / 15);
        if (o == "")
            for (i = 0; i < $(".houseInfo").length; i++) t.push($($(".houseInfo")[i]).attr("data-id"));
        else t.push(o);
        $(this).next("button").length !== 0 ? (f > 1 ? f-- : f = 1, f >= 1 && f <= n && (c.SearchRooms(t.join(","), f, r, u, function (n) {
            n.Rooms.length > 0 && a(n.Rooms)
        }), f == 1 && $(this).addClass("btn-disable"), f === n && $(this).addClass("btn-disable"))) : ((s > 16 || e > 16) && f <= n ? f++ : f = n, f <= n && f > 1 && (f === n && $(this).addClass("btn-disable"), c.SearchRooms(t.join(","), f, r, u, function (n) { console.log(n); n.Rooms.length > 0 && a(n.Rooms) })))
    });
    $(".left_sub button").on("click", function () { $(".notHoust").fadeOut(300) });
    $(".serach_house_name button").on("click", function () {
        var t = $(".inputName").attr("data-Lat"),
            f = $(".inputName").attr("data-Lng"),
            o;
        t !== undefined && f !== undefined ? t > 0 && f > 0 ? (n.centerAndZoom(new BMap.Point(f, t), 15), e(r, u)) : ($(".notHoust").show(), $(".inputName").removeAttr("data-Lng"), $(".inputName").removeAttr("data-Lat"), n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays()) : t > 0 && f > 0 ? (n.centerAndZoom(new BMap.Point(f, t), 15), e(r, u)) : (console.log(i), o = $(".inputName").val(), o.length > 0 ? i[0].Name.indexOf(o) !== -1 && (n.centerAndZoom(new BMap.Point(i[0].Lng, i[0].Lat), 15), e(r, u)) : (n.centerAndZoom(new BMap.Point(s, h), 13), n.clearOverlays(), $(".notHoust").show(), $(".inputName").removeAttr("data-Lng"), $(".inputName").removeAttr("data-Lat")))
    })
});



$(function () {
    var boxHeight = $(window).height();
    $(".main_content").height(boxHeight - 70);
    $(window).resize(function () {
        var boxHeight = $(window).height();
        $(".main_content").height(boxHeight);
        var totalHeight = $(".serach_map_house").height();
        $(".house_list").height(totalHeight - 140);
    })
    //右侧房源的显示
    var totalHeight = $(".serach_map_house").height();
    $(".house_list").height(totalHeight - 140);

    var funPlaceholder = function (element) {
        var placeholder = '';
        if (element && !("placeholder" in document.createElement("input")) && (placeholder = element.getAttribute("placeholder"))) {
            element.onfocus = function () {
                if (this.value === placeholder) {
                    this.value = "";
                }
                this.style.color = '';
            };
            element.onblur = function () {
                if (this.value === "") {
                    this.value = placeholder;
                    this.style.color = 'graytext';
                }
            };

            //样式初始化

            if (element.value === "") {
                element.value = placeholder;
                element.style.color = 'graytext';
            }
        }
    };

    funPlaceholder(document.getElementById("inputName"));
});


